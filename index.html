<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loop Timer with Beep and Flash</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background-color: #f4f4f4;
      transition: background-color 0.3s ease;
    }

    input, button {
      font-size: 18px;
      padding: 10px;
      margin: 10px;
    }

    button {
      background-color: #ffcc00;
      border-style: none;
      border-radius: 10px;
    }

    .timer {
      margin: 20px 0;
      font-size: 5vh;
    }

    /* Green flash animation */
    .flash-green {
      animation: flashGreen 0.3s;
    }

    @keyframes flashGreen {
      0% { background-color: #4CAF50; }
      100% { background-color: #f4f4f4; }
    }
  </style>
</head>
<body>

  <label>Total Time (minutes): <input type="number" id="totalTime" min="1" value="20"></label><br>
  <label>Repetitions: <input type="number" id="repetitions" min="1" value="80"></label><br>
  <button onclick="startTimer()">Start</button>
  <button onclick="pauseResumeTimer()">Pause</button>

  <div class="timer">
    <div>Total Time Left: <span id="totalTimer">00:00:00.00</span></div>
    <div>Burpee Count <span id="currentRep">0</span> / <span id="totalReps">0</span></div>
    <div>Loop Time Left: <span id="loopTimer">00:00:00.00</span></div>
  </div>

  <script>
    let totalDuration = 0;
    let loopDuration = 0;
    let repetitions = 0;
    let currentRep = 0;

    let totalEndTime = 0;
    let loopEndTime = 0;

    let paused = false;
    let pauseTime = 0;
    let interval;

    let beepTracker = { 2: false, 1: false, 0: false };

    function startTimer() {
      clearInterval(interval);
      paused = false;

      const totalMinutes = parseFloat(document.getElementById('totalTime').value);
      repetitions = parseInt(document.getElementById('repetitions').value);

      totalDuration = totalMinutes * 60 * 1000;
      loopDuration = totalDuration / repetitions;

      currentRep = 1;
      totalEndTime = Date.now() + totalDuration;
      loopEndTime = Date.now() + loopDuration;

      beepTracker = { 2: false, 1: false, 0: false };

      document.getElementById('totalReps').textContent = repetitions;
      document.getElementById('currentRep').textContent = currentRep;

      interval = setInterval(updateTimers, 10);
    }

    function pauseResumeTimer() {
      if (!interval) return;

      if (!paused) {
        paused = true;
        clearInterval(interval);
        pauseTime = Date.now();
      } else {
        const now = Date.now();
        const pauseOffset = now - pauseTime;

        totalEndTime += pauseOffset;
        loopEndTime += pauseOffset;

        paused = false;
        interval = setInterval(updateTimers, 10);
      }
    }

    function updateTimers() {
      const now = Date.now();

      let totalRemaining = totalEndTime - now;
      let loopRemaining = loopEndTime - now;

      if (totalRemaining <= 0) {
        totalRemaining = 0;
        loopRemaining = 0;
        clearInterval(interval);
      }

      // Handle loop reset
      if (loopRemaining <= 0 && currentRep < repetitions) {
        currentRep++;
        loopEndTime = Date.now() + loopDuration;
        loopRemaining = loopDuration;
        beepTracker = { 2: false, 1: false, 0: false };
        document.getElementById('currentRep').textContent = currentRep;

        playBeep();           // ðŸ”Š Beep at end of loop
        flashScreenGreen();   // ðŸŸ© Flash screen green
      }

      // Beep on last 3, 2, 1 seconds
      const secondsLeft = Math.floor(loopRemaining / 1000);
      if (secondsLeft <= 2 && secondsLeft >= 0 && !beepTracker[secondsLeft]) {
        playBeep();
        beepTracker[secondsLeft] = true;
      }

      document.getElementById('totalTimer').textContent = formatTime(totalRemaining);
      document.getElementById('loopTimer').textContent = formatTime(loopRemaining);
    }

    function formatTime(ms) {
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      const deciMs = Math.floor((ms % 1000) / 10);

      return (
        String(hours).padStart(2, '0') + ':' +
        String(minutes).padStart(2, '0') + ':' +
        String(seconds).padStart(2, '0') + '.' +
        String(deciMs).padStart(2, '0')
      );
    }

    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();

      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(800, ctx.currentTime);
      gainNode.gain.setValueAtTime(0.2, ctx.currentTime);

      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);

      oscillator.start();
      oscillator.stop(ctx.currentTime + 0.15);
    }

    function flashScreenGreen() {
      document.body.classList.add('flash-green');
      setTimeout(() => {
        document.body.classList.remove('flash-green');
      }, 300);
    }
  </script>
</body>
</html>
